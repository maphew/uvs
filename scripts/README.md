# uvs

Minimal installer that converts a single-file PEP723-style script into a temporary package and runs `uv tool install` on it.

This repository includes an example single-file script at [`uvs-example.py`](uvs-example.py) and the installer at [`scripts/uvs.py`](scripts/uvs.py).

## Purpose

`uvs` makes it easy to take a self-contained single-file PEP723-style Python script and install it as a normal command-line tool using `uv tool install`. It:

- Parses a small PEP723-style header block from the script.
- Generates a temporary package directory with `pyproject.toml` and `src/<module>/__init__.py`.
- Calls `uv tool install` on the generated package.
- Records installs in a project-local registry file [`.uvs-registry.json`](.uvs-registry.json).

This is useful for authoring single-file utilities and installing them without manually creating a package.

## Quickstart

Dry-run (generate package but do not call `uv`):

```
uv run  scripts/uvs.py --dry-run uvs-example.py
```

Sample dry-run output (illustrative):

```
Generated package at: /tmp/uvs-abc123/uvs-single
```

Real install:

```
uv run  scripts/uvs.py uvs-example.py
```

Sample successful output (illustrative):

```
Generated package at: /tmp/uvs-abc123/uvs-single
Running: uv tool install /tmp/uvs-abc123/uvs-single
Installed 'uvs-single' from /full/path/to/uvs-example.py
```

After a successful install the local registry file [`.uvs-registry.json`](.uvs-registry.json) is updated.

## Usage

Run the installer script (example):

```
uv run  scripts/uvs.py [OPTIONS] <script-or-dir>
```

Flags

- `--dry-run`
  - Do not invoke `uv tool install`. The tool will generate the package layout and print the package path then exit.
  - Useful for inspection and debugging.

- `--editable`
  - Pass `-e` to `uv tool install` to attempt an editable install (i.e., `uv tool install -e <pkg>`).
  - **Important limitations**: Editable installs have significant limitations (see "Editable Install Limitations" section below).

- `--all`
  - When provided, install all `.py` files in the given directory (or current directory if no script/directory argument).
  - Example: `uv run  scripts/uvs.py --all .`

- `--list`
  - Print the entries in the local registry [`.uvs-registry.json`](.uvs-registry.json) and exit.
  - Example output:
    ```
    uvs-single    <- /full/path/to/uvs-example.py (version: 0.1.0)
    ```

- `--which <tool>`
  - Show the recorded source path for an installed tool name from the local registry.
  - Example:
    ```
    uv run  scripts/uvs.py --which uvs-single
    # prints: /full/path/to/uvs-example.py
    ```

- `--update`
  - If a registry entry exists, `--update` compares the source file hash and, if changed, bumps the patch version (e.g., 0.1.0 -> 0.1.1) and reinstalls.
  - If no change is detected, the existing version is reused/reinstalled.

- `--name`, `-n <name>`
  - Override the derived CLI/tool name. By default the installer derives name from the script filename (underscores -> hyphens for CLI name).
  - Example: `--name my-cool-tool` will produce an installed CLI `my-cool-tool`.

- `--version`, `-v <version>`
  - Initial package version when generating `pyproject.toml`. Default: `0.1.0`.

- `--tempdir <path>`
  - Directory where the temporary package will be generated. By default a system temporary directory is used (e.g., `/tmp/uvs-...`).

- `--python <specifier>`
  - Forwarded to `uv tool install --python ...`. Use to select the Python interpreter/version used by `uv` when installing.

## PEP 723 Support

`uvs` reads [PEP 723](https://peps.python.org/pep-0723/) inline script metadata to extract dependency and Python version requirements. See [`uvs-example.py`](uvs-example.py) for a complete example.

The tool supports the standard `requires-python` and `dependencies` fields from PEP 723. If no metadata is present, sensible defaults are used.

## How the generated package looks

When the installer runs it generates a temporary package directory with this minimal layout:

- /tmp/.../my-tool/               <-- package directory generated by the tool
  - pyproject.toml                <-- contains project metadata and [tool.uvs] metadata
  - README.md                     <-- generated README for the package
  - src/
    - my_tool/                    <-- module name (hyphens converted to underscores)
      - __init__.py               <-- the original script body (header + __main__ stripped)

Example tree (illustrative):

```
/tmp/uvs-abc123/uvs-single
├── pyproject.toml
├── README.md
└── src
    └── uv_single
        └── __init__.py
```

Embedded metadata:
- `pyproject.toml` contains the normal `[project]` fields (name, version, description, dependencies) and a `[tool.uvs]` section with:
  - `source_path`
  - `source_hash`
  - `generated_at`
  - `generator`

The registry file [`.uvs-registry.json`](.uvs-registry.json) is written in the current working directory (project-local). Each installed script is recorded under `scripts` with entries like:

- `tool_name`
- `source_path` (absolute)
- `source_hash`
- `installed_at`
- `version`

## Finding the original source of an installed tool

To find where a recorded tool came from, use:

```
uv run  scripts/uvs.py --which <tool-name>
```

This prints the `source_path` recorded in [`.uvs-registry.json`](.uvs-registry.json).

You can also inspect the registry directly:

```
cat .uvs-registry.json
```

## Uninstalling

Because the installer generates a standard package and installs it with `uv tool install`, uninstalling works normally via `uv`:

```
uv tool uninstall <tool-name>
```

The registry is not automatically purged by `uv`—you can manually edit or remove [`.uvs-registry.json`](.uvs-registry.json) if you want to remove the record.

## Troubleshooting / common failure modes

- "Script not found" — you passed a path that doesn't exist. Check the path, e.g. [`uvs-example.py`](uvs-example.py).
- Missing `main()` — the generated package sets `project.scripts` entry to point to `<module>:main`. Ensure your script exposes a `def main(): ...`. If not, `uv` will fail at runtime.
- Incompatible `requires-python` — if the header specifies `requires-python` that doesn't match the environment used by `uv` or the target interpreter, installation may fail. Use `--python` to select a compatible interpreter or remove/adjust `requires-python`.
- `uv` not installed or not on PATH — the tool invokes `uv tool install`. Ensure `uv` is installed and available in your shell.
- Permission issues during install — if `uv tool install` needs elevated permissions (system-level installs), you may need to run under an environment where you have permissions, use virtual environments, or use `--editable` to avoid global installs.
- Registry write failure — the tool attempts to write `.uvs-registry.json` in the current directory. If that fails (permissions, read-only FS), the tool prints a warning but the install may still succeed.
- Editable install failures — `--editable` has known limitations and may not work as expected (see below).

## Editable Install Limitations

**Important**: Editable installs (`--editable` flag) have significant limitations that make them unsuitable for most use cases:

1. **No Live Updates**: Changes to your source script are **not** automatically reflected in the installed tool. The installed tool points to the generated package, not your original script.

2. **Generated Package Dependency**: The editable install references the temporary generated package, not your source script directly. This breaks the expected "live update" behavior of traditional editable installs.

3. **Update Required**: To reflect changes in your script, you must re-run the installer with the `--update` flag.

4. **Temporary Directory Issues**: The generated package may be in a temporary directory that could be cleaned up by the system.

**Recommendation**: Avoid using `--editable` for most workflows. Instead, use the `--update` flag when you've made changes to your script:

```bash
# After modifying your script
uv run scripts/uvs.py --update your-script.py
```

The `--editable` flag is retained for experimental use and may be improved in future versions.

## Examples

1) Dry-run (generate package only):

```
uv run  scripts/uvs.py --dry-run uvs-example.py
```

Output:

```
Generated package at: /tmp/uvs-abc123/uvs-single
```

2) Install and register:

```
uv run  scripts/uvs.py uvs-example.py
```

Output (example):

```
Generated package at: /tmp/uvs-abc123/uvs-single
Running: uv tool install /tmp/uvs-abc123/uvs-single
Installed 'uvs-single' from /home/me/projects/uvs/uvs-example.py
```

3) List registered scripts:

```
uv run  scripts/uvs.py --list
```

Output:

```
uvs-single  <- /home/me/projects/uvs/uvs-example.py (version: 0.1.0)
```

4) Show source for a tool:

```
uv run  scripts/uvs.py --which uvs-single
# prints: /home/me/projects/uvs/uvs-example.py
```

5) Update (bump patch and reinstall if changed):

```
uv run  scripts/uvs.py --update uvs-example.py
```

## Registry example (anonymized)

A small example of what [`.uvs-registry.json`](.uvs-registry.json) might contain after installs:

```json
{
  "version": "1.0",
  "created_at": "2025-10-03T12:00:00+00:00",
  "scripts": {
    "uvs-single": {
      "tool_name": "uvs-single",
      "source_path": "/home/me/projects/uvs/uvs-example.py",
      "source_hash": "d2b2f3b4...adf123",
      "installed_at": "2025-10-03T12:01:00+00:00",
      "version": "0.1.0"
    }
  }
}
```

## Latest Findings and Updates

### Editable Install Analysis
After thorough testing, we've determined that editable installs have fundamental limitations:
- The editable install points to the generated package layout, not the original script
- Changes to source scripts are not automatically reflected
- This behavior is unsurmountable without significant additional complexity
- The `--editable` flag is retained for experimental use but not recommended

### Registry Improvements
- The registry now stores absolute paths to source scripts for better reliability
- Source hash comparison enables reliable change detection for updates
- Version bumping is automated when using the `--update` flag

### Package Generation
- Generated packages now include comprehensive metadata in the `[tool.uvs]` section
- Source paths are stored as absolute paths for better traceability
- Timestamps and generator version are recorded for debugging

## Next steps / roadmap

- Batch install UX: more controls for `--all` (include/exclude patterns).
- Consider removing or improving editable install functionality.
- Support for additional PEP723 metadata in the header (license, authors, classifiers).
- Option: auto-prune registry entries on uninstall.
- Tests and CI to validate generated packages against a real `uv` install workflow.
- Global registry option (store in user home directory instead of project-local).

Contributions are welcome. Open a PR against this repository and include tests and examples demonstrating new behaviors.

---
File references in this README:
- Installer script: [`scripts/uvs.py`](scripts/uvs.py)
- Example single-file script: [`uvs-example.py`](uvs-example.py)
- Registry file: [`.uvs-registry.json`](.uvs-registry.json)
